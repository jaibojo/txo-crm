<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TalentXO CRM - Enterprise Sales Intelligence</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; overflow-x: hidden; }

/* Login */
.login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
.login-box { background: white; padding: 50px; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 420px; width: 90%; }
.login-box h1 { font-size: 32px; margin-bottom: 10px; color: #2c3e50; }
.login-box p { color: #7f8c8d; margin-bottom: 30px; font-size: 15px; }
.login-box input { width: 100%; padding: 16px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
.login-box input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
.login-box button { width: 100%; padding: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 17px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
.login-box button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102,126,234,0.4); }
.error-msg { color: #e74c3c; font-size: 14px; margin-bottom: 15px; display: none; padding: 10px; background: #fee; border-radius: 6px; }

/* Main App */
.app { display: none; }
.app-layout { display: flex; height: 100vh; }

/* Sidebar */
.sidebar { width: 260px; background: #2c3e50; color: white; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
.sidebar-header { padding: 25px 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); }
.sidebar-header h1 { font-size: 22px; margin-bottom: 5px; }
.sidebar-header p { font-size: 12px; opacity: 0.7; }
.sidebar-nav { flex: 1; padding: 20px 0; overflow-y: auto; }
.nav-item { padding: 14px 25px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; color: rgba(255,255,255,0.8); border-left: 3px solid transparent; }
.nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
.nav-item.active { background: rgba(102,126,234,0.2); border-left-color: #667eea; color: white; }
.nav-item-icon { margin-right: 12px; font-size: 18px; width: 24px; }
.sidebar-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); }
.logout-btn { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
.logout-btn:hover { background: rgba(255,255,255,0.2); }

/* Main Content */
.main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.top-bar { background: white; padding: 20px 30px; border-bottom: 1px solid #e1e8ed; box-shadow: 0 2px 4px rgba(0,0,0,0.04); display: flex; align-items: center; justify-content: space-between; }
.search-global { width: 100%; max-width: 600px; padding: 12px 20px 12px 45px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 15px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 15px center; }
.search-global:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
.user-info { display: flex; align-items: center; gap: 15px; }
.user-avatar { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px; }
.content-area { flex: 1; overflow-y: auto; padding: 30px; }

.page { display: none; }
.page.active { display: block; animation: fadeIn 0.3s; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.page-header { margin-bottom: 30px; }
.page-header h2 { font-size: 28px; color: #2c3e50; margin-bottom: 8px; }
.page-header p { color: #7f8c8d; font-size: 15px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border-left: 4px solid #667eea; transition: transform 0.2s; }
.stat-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.stat-card h3 { font-size: 12px; color: #7f8c8d; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
.stat-card .number { font-size: 36px; font-weight: 700; color: #2c3e50; }

.data-table { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; margin-top: 20px; }
table { width: 100%; border-collapse: collapse; }
th { text-align: left; padding: 16px 20px; background: #f8f9fa; font-weight: 600; border-bottom: 2px solid #e1e8ed; color: #2c3e50; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
td { padding: 14px 20px; border-bottom: 1px solid #f1f3f5; color: #34495e; font-size: 14px; }
tbody tr { transition: background 0.15s; cursor: pointer; }
tbody tr:hover { background: #f8f9fa; }

.badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
.badge-green { background: #d4edda; color: #155724; }
.badge-yellow { background: #fff3cd; color: #856404; }
.badge-blue { background: #cce5ff; color: #004085; }
.badge-red { background: #f8d7da; color: #721c24; }
.badge-gray { background: #e2e3e5; color: #383d41; }

/* Modal */
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; padding: 20px; }
.modal.active { display: flex; animation: fadeIn 0.3s; }
.modal-content { background: white; border-radius: 16px; max-width: 1000px; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
.modal-header { padding: 25px 30px; border-bottom: 2px solid #e1e8ed; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
.modal-header h2 { font-size: 24px; color: #2c3e50; }
.modal-close { background: none; border: none; font-size: 32px; cursor: pointer; color: #7f8c8d; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s; }
.modal-close:hover { background: #e1e8ed; color: #2c3e50; }
.modal-body { padding: 30px; max-height: calc(90vh - 100px); overflow-y: auto; }

.tabs { display: flex; border-bottom: 2px solid #e1e8ed; margin-bottom: 25px; }
.tab-btn { flex: 1; padding: 14px 20px; border: none; background: none; cursor: pointer; font-size: 15px; font-weight: 500; color: #7f8c8d; transition: all 0.2s; border-bottom: 3px solid transparent; }
.tab-btn:hover { color: #667eea; background: rgba(102,126,234,0.05); }
.tab-btn.active { color: #667eea; border-bottom-color: #667eea; }

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s; }

.info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px; }
.info-item { padding: 18px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #667eea; }
.info-item label { font-size: 11px; color: #7f8c8d; text-transform: uppercase; display: block; margin-bottom: 8px; letter-spacing: 0.5px; font-weight: 600; }
.info-item value { font-size: 16px; color: #2c3e50; font-weight: 600; display: block; }

.loading { text-align: center; padding: 60px 20px; color: #7f8c8d; }
.empty-state { text-align: center; padding: 80px 20px; color: #7f8c8d; }
.empty-state h3 { margin-bottom: 10px; color: #34495e; font-size: 20px; }

.email-thread { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea; cursor: pointer; transition: all 0.2s; }
.email-thread:hover { background: #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.email-thread-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.email-thread-subject { font-weight: 600; color: #2c3e50; font-size: 15px; }
.email-thread-date { font-size: 12px; color: #7f8c8d; }
.email-thread-info { font-size: 13px; color: #7f8c8d; }
.email-message { background: white; padding: 12px; border-radius: 6px; margin-top: 10px; border: 1px solid #e1e8ed; }
.email-meta { font-size: 12px; color: #7f8c8d; margin-bottom: 8px; }

.pagination { display: flex; justify-content: center; align-items: center; margin-top: 30px; gap: 10px; }
.pagination button { padding: 8px 16px; border: 1px solid #e1e8ed; background: white; border-radius: 6px; cursor: pointer; transition: all 0.2s; font-size: 14px; }
.pagination button:hover:not(:disabled) { background: #667eea; color: white; border-color: #667eea; }
.pagination button.active { background: #667eea; color: white; border-color: #667eea; }
.pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
.pagination-info { color: #7f8c8d; font-size: 14px; }

.search-results { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 20px; margin-top: 20px; }
.search-result-item { padding: 15px; border-bottom: 1px solid #e1e8ed; cursor: pointer; transition: background 0.15s; }
.search-result-item:hover { background: #f8f9fa; }
.search-result-item:last-child { border-bottom: none; }
.search-result-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
.search-result-type { display: inline-block; padding: 2px 8px; background: #667eea; color: white; font-size: 10px; border-radius: 4px; margin-right: 8px; }
.search-result-info { font-size: 13px; color: #7f8c8d; }

.filter-bar { background: white; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.04); }
.filter-bar select { padding: 8px 12px; border: 2px solid #e1e8ed; border-radius: 6px; font-size: 14px; cursor: pointer; }
.filter-bar select:focus { outline: none; border-color: #667eea; }
</style>
</head>
<body>

<!-- Login Screen -->
<div class="login-screen" id="loginScreen">
    <div class="login-box">
        <h1>TalentXO CRM</h1>
        <p>Enterprise Sales Intelligence Platform</p>
        <div class="error-msg" id="loginError">Invalid password</div>
        <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter') login()">
        <button onclick="login()">Sign In</button>
    </div>
</div>

<!-- Main Application -->
<div class="app" id="app">
    <div class="app-layout">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>TalentXO</h1>
                <p>Sales Intelligence CRM</p>
            </div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <span class="nav-item-icon">üìä</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('companies')">
                    <span class="nav-item-icon">üè¢</span>
                    <span>Companies</span>
                </div>
                <div class="nav-item" onclick="showPage('contacts')">
                    <span class="nav-item-icon">üë•</span>
                    <span>Contacts</span>
                </div>
                <div class="nav-item" onclick="showPage('emails')">
                    <span class="nav-item-icon">üìß</span>
                    <span>Email Communications</span>
                </div>
                <div class="nav-item" onclick="showPage('roles')">
                    <span class="nav-item-icon">üíº</span>
                    <span>Roles</span>
                </div>
            </div>
            <div class="sidebar-footer">
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <div class="top-bar">
                <input type="text" class="search-global" id="globalSearch" placeholder="Search companies, contacts, emails..." oninput="performGlobalSearch()">
                <div class="user-info">
                    <div class="user-avatar">JG</div>
                </div>
            </div>

            <div class="content-area">
                <!-- Dashboard Page -->
                <div class="page active" id="dashboardPage">
                    <div class="page-header">
                        <h2>Dashboard</h2>
                        <p>Overview of your recruitment sales intelligence</p>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Companies</h3>
                            <div class="number" id="totalCompanies">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Active Companies</h3>
                            <div class="number" id="activeCompanies">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Roles</h3>
                            <div class="number" id="totalRoles">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total SPOCs</h3>
                            <div class="number" id="totalSPOCs">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Email Threads</h3>
                            <div class="number" id="totalEmails">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Verified Companies</h3>
                            <div class="number" id="verifiedCompanies">0</div>
                        </div>
                    </div>

                    <!-- Funnel & Role Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div class="data-table">
                            <h3 style="padding: 20px 20px 0; color: #2c3e50;">Companies by Funnel Stage</h3>
                            <div id="funnelStatsContainer" style="padding: 20px;">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                        <div class="data-table">
                            <h3 style="padding: 20px 20px 0; color: #2c3e50;">Roles by Status</h3>
                            <div id="roleStatsContainer" style="padding: 20px;">
                                <div class="loading">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-table">
                        <h3 style="padding: 20px 20px 0; color: #2c3e50;">Recent Activity</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Company</th>
                                    <th>Status</th>
                                    <th>Last Contact</th>
                                    <th>Roles</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivityTable">
                                <tr><td colspan="5" class="loading">Loading data...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Companies Page -->
                <div class="page" id="companiesPage">
                    <div class="page-header">
                        <h2>Companies</h2>
                        <p>All <span id="companiesCount">0</span> companies in your database</p>
                    </div>
                    <div class="filter-bar">
                        <select id="statusFilter" onchange="filterCompanies()">
                            <option value="">All Status</option>
                            <option value="Active">Active</option>
                            <option value="Verified">Verified</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                        <select id="sortCompanies" onchange="filterCompanies()">
                            <option value="name">Sort by Name</option>
                            <option value="onboarding_date">Sort by Onboarding Date</option>
                            <option value="revenue">Sort by Revenue</option>
                        </select>
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Company Name</th>
                                    <th>Status</th>
                                    <th>Funnel Stage</th>
                                    <th>First Engagement</th>
                                    <th>Roles</th>
                                    <th>SPOCs</th>
                                    <th>Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="companiesTable">
                                <tr><td colspan="7" class="loading">Loading companies...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="companiesPagination"></div>
                </div>

                <!-- Contacts Page -->
                <div class="page" id="contactsPage">
                    <div class="page-header">
                        <h2>Contacts (SPOCs)</h2>
                        <p>All <span id="contactsCount">0</span> single points of contact</p>
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Company</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Position</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTable">
                                <tr><td colspan="6" class="loading">Loading contacts...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="contactsPagination"></div>
                </div>

                <!-- Emails Page -->
                <div class="page" id="emailsPage">
                    <div class="page-header">
                        <h2>Email Communications</h2>
                        <p>All <span id="emailsCount">0</span> email conversations</p>
                    </div>
                    <div class="filter-bar">
                        <select id="emailCompanyFilter" onchange="filterEmails()">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    <div id="emailThreadsList">
                        <div class="loading">Loading email communications...</div>
                    </div>
                    <div class="pagination" id="emailsPagination"></div>
                </div>

                <!-- Roles Page -->
                <div class="page" id="rolesPage">
                    <div class="page-header">
                        <h2>Roles</h2>
                        <p>All <span id="rolesCount">0</span> recruitment roles</p>
                    </div>
                    <div class="data-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Role Title</th>
                                    <th>Company</th>
                                    <th>Start Date</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody id="rolesTable">
                                <tr><td colspan="5" class="loading">Loading roles...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination" id="rolesPagination"></div>
                </div>

                <!-- Search Results Page -->
                <div class="page" id="searchResultsPage">
                    <div class="page-header">
                        <h2>Search Results</h2>
                        <p id="searchResultsInfo">Search for companies, contacts, or emails</p>
                    </div>
                    <div class="search-results" id="searchResultsContainer">
                        <div class="empty-state">
                            <h3>No search performed yet</h3>
                            <p>Use the search bar above to find companies, contacts, or emails</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Company Detail Modal -->
<div class="modal" id="companyModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalCompanyName">Company Details</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('roles')">Roles</button>
                <button class="tab-btn" onclick="switchTab('spocs')">SPOCs</button>
                <button class="tab-btn" onclick="switchTab('emails')">Emails</button>
            </div>

            <div class="tab-content active" id="overviewTab">
                <div class="info-grid" id="companyOverview">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="tab-content" id="rolesTab">
                <div id="companyRoles">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="tab-content" id="spocsTab">
                <div id="companySPOCs">
                    <div class="loading">Loading...</div>
                </div>
            </div>

            <div class="tab-content" id="emailsTab">
                <div id="companyEmails">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Email Thread Detail Modal -->
<div class="modal" id="emailThreadModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalThreadSubject">Email Thread</h2>
            <button class="modal-close" onclick="closeEmailModal()">&times;</button>
        </div>
        <div class="modal-body" id="emailThreadContent">
            <div class="loading">Loading...</div>
        </div>
    </div>
</div>

<script>
let crmData = null;
let currentPage = 'dashboard';
let currentCompanyData = null;
const itemsPerPage = 50;
let currentPageNum = {
    companies: 1,
    contacts: 1,
    emails: 1,
    roles: 1
};
let filteredData = {
    companies: [],
    contacts: [],
    emails: [],
    roles: []
};

// Login
function login() {
    const password = document.getElementById('passwordInput').value;
    if (password === 'aa11') {
        sessionStorage.setItem('authenticated', 'true');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadData();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function logout() {
    sessionStorage.removeItem('authenticated');
    location.reload();
}

// Check authentication on load
window.onload = function() {
    if (sessionStorage.getItem('authenticated') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        loadData();
    }
};

// Load data
function loadData() {
    fetch('crm_data.json')
        .then(response => response.json())
        .then(data => {
            crmData = data;
            initializeDashboard();
            initializeCompanies();
            initializeContacts();
            initializeEmails();
            initializeRoles();
            populateEmailCompanyFilter();
        })
        .catch(error => {
            console.error('Error loading data:', error);
            alert('Error loading CRM data. Please refresh the page.');
        });
}

// Navigation
function showPage(pageName) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    const pageMap = {
        'dashboard': 'dashboardPage',
        'companies': 'companiesPage',
        'contacts': 'contactsPage',
        'emails': 'emailsPage',
        'roles': 'rolesPage',
        'search': 'searchResultsPage'
    };

    document.getElementById(pageMap[pageName]).classList.add('active');
    document.querySelector(`.nav-item[onclick*="${pageName}"]`).classList.add('active');
    currentPage = pageName;
}

// Dashboard
function initializeDashboard() {
    const stats = crmData.stats || {};
    const companies = crmData.companies || [];
    const emails = crmData.email_conversations || [];

    // Calculate funnel stats from emails
    const funnelStats = {};
    emails.forEach(e => {
        const funnel = e.funnel || 'Unknown';
        funnelStats[funnel] = (funnelStats[funnel] || 0) + 1;
    });

    // Calculate role stats by status
    const roleStats = {};
    companies.forEach(c => {
        (c.roles || []).forEach(r => {
            const status = r.status || 'Unknown';
            roleStats[status] = (roleStats[status] || 0) + 1;
        });
    });

    // Add funnel stage to companies from emails
    companies.forEach(c => {
        const companyEmails = emails.filter(e => e.company === c.company_name);
        if (companyEmails.length > 0) {
            // Get the most recent funnel stage
            const sortedEmails = companyEmails.sort((a, b) => {
                return new Date(b.last_date || 0) - new Date(a.last_date || 0);
            });
            c.funnel_stage = sortedEmails[0].funnel || 'Unknown';
        } else {
            c.funnel_stage = 'No Contact';
        }
    });

    document.getElementById('totalCompanies').textContent = (stats.total_companies || 0).toLocaleString();
    document.getElementById('activeCompanies').textContent = (stats.active_companies || 0).toLocaleString();
    document.getElementById('totalRoles').textContent = (stats.total_roles || 0).toLocaleString();
    document.getElementById('totalSPOCs').textContent = (stats.total_spocs || 0).toLocaleString();
    document.getElementById('totalEmails').textContent = (emails.length || 0).toLocaleString();
    document.getElementById('verifiedCompanies').textContent = (stats.verified_companies || 0).toLocaleString();

    // Funnel breakdown by company count
    const companyFunnelStats = {};
    companies.forEach(c => {
        const funnel = c.funnel_stage || 'Unknown';
        companyFunnelStats[funnel] = (companyFunnelStats[funnel] || 0) + 1;
    });

    // Display funnel stats
    const funnelContainer = document.getElementById('funnelStatsContainer');
    const funnelEntries = Object.entries(companyFunnelStats).sort((a, b) => b[1] - a[1]);
    funnelContainer.innerHTML = funnelEntries.length > 0 ?
        funnelEntries.map(([funnel, count]) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #667eea;">
                <span style="font-weight: 600; color: #2c3e50;">${funnel}</span>
                <span class="badge badge-${getStatusColor(funnel)}">${count} companies</span>
            </div>
        `).join('') : '<p style="color: #7f8c8d;">No funnel data available</p>';

    // Display role stats
    const roleContainer = document.getElementById('roleStatsContainer');
    const roleEntries = Object.entries(roleStats).sort((a, b) => b[1] - a[1]);
    roleContainer.innerHTML = roleEntries.length > 0 ?
        roleEntries.map(([status, count]) => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; margin-bottom: 10px; border-radius: 6px; border-left: 3px solid #667eea;">
                <span style="font-weight: 600; color: #2c3e50;">${status}</span>
                <span class="badge badge-${getStatusColor(status)}">${count} roles</span>
            </div>
        `).join('') : '<p style="color: #7f8c8d;">No role data available</p>';

    // Recent activity (top 10 companies by engagement)
    const recentCompanies = companies.slice(0, 10);
    const tbody = document.getElementById('recentActivityTable');
    tbody.innerHTML = recentCompanies.map(c => `
        <tr onclick="showCompanyDetail('${c.company_name.replace(/'/g, "\\'")}')">
            <td><strong>${c.company_name}</strong></td>
            <td><span class="badge badge-${getStatusColor(c.status)}">${c.status || 'N/A'}</span></td>
            <td>${c.last_engagement || 'N/A'}</td>
            <td>${c.roles_count || 0}</td>
            <td>${c.revenue || 'N/A'}</td>
        </tr>
    `).join('');
}

// Companies
function initializeCompanies() {
    const companies = crmData.companies || [];
    document.getElementById('companiesCount').textContent = companies.length.toLocaleString();
    filteredData.companies = companies;
    renderCompanies(companies, 1);
}

function filterCompanies() {
    const statusFilter = document.getElementById('statusFilter').value;
    const sortBy = document.getElementById('sortCompanies').value;

    let filtered = [...(crmData.companies || [])];

    if (statusFilter) {
        filtered = filtered.filter(c => c.status === statusFilter);
    }

    // Sort
    filtered.sort((a, b) => {
        if (sortBy === 'name') return a.company_name.localeCompare(b.company_name);
        if (sortBy === 'onboarding_date') return new Date(b.onboarding_date || 0) - new Date(a.onboarding_date || 0);
        if (sortBy === 'revenue') return parseFloat(b.revenue || 0) - parseFloat(a.revenue || 0);
        return 0;
    });

    filteredData.companies = filtered;
    currentPageNum.companies = 1;
    renderCompanies(filtered, 1);
}

function renderCompanies(companies, page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageCompanies = companies.slice(start, end);

    const tbody = document.getElementById('companiesTable');
    tbody.innerHTML = pageCompanies.length > 0 ? pageCompanies.map(c => `
        <tr onclick="showCompanyDetail('${c.company_name.replace(/'/g, "\\'")}')">
            <td><strong>${c.company_name}</strong></td>
            <td><span class="badge badge-${getStatusColor(c.status)}">${c.status || 'N/A'}</span></td>
            <td><span class="badge badge-${getStatusColor(c.funnel_stage)}">${c.funnel_stage || 'Unknown'}</span></td>
            <td>${c.first_engagement || 'N/A'}</td>
            <td>${c.roles_count || 0}</td>
            <td>${c.spocs_count || 0}</td>
            <td>${c.revenue || 'N/A'}</td>
        </tr>
    `).join('') : '<tr><td colspan="7" class="empty-state">No companies found</td></tr>';

    renderPagination('companies', companies.length, page);
}

// Contacts
function initializeContacts() {
    const spocs = crmData.companies ? crmData.companies.flatMap(c =>
        (c.spocs || []).map(s => ({...s, company: c.company_name}))
    ) : [];
    document.getElementById('contactsCount').textContent = spocs.length.toLocaleString();
    filteredData.contacts = spocs;
    renderContacts(spocs, 1);
}

function renderContacts(contacts, page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageContacts = contacts.slice(start, end);

    const tbody = document.getElementById('contactsTable');
    tbody.innerHTML = pageContacts.length > 0 ? pageContacts.map(c => `
        <tr>
            <td><strong>${c.name || 'N/A'}</strong></td>
            <td>${c.company || 'N/A'}</td>
            <td>${c.email || 'N/A'}</td>
            <td>${c.phone || 'N/A'}</td>
            <td>${c.position || 'N/A'}</td>
            <td><span class="badge badge-${getStatusColor(c.status)}">${c.status || 'N/A'}</span></td>
        </tr>
    `).join('') : '<tr><td colspan="6" class="empty-state">No contacts found</td></tr>';

    renderPagination('contacts', contacts.length, page);
}

// Emails
function initializeEmails() {
    const emails = crmData.email_conversations || [];
    document.getElementById('emailsCount').textContent = emails.length.toLocaleString();
    filteredData.emails = emails;
    renderEmails(emails, 1);
}

function populateEmailCompanyFilter() {
    const companies = [...new Set((crmData.email_conversations || []).map(e => e.company))].sort();
    const select = document.getElementById('emailCompanyFilter');
    select.innerHTML = '<option value="">All Companies</option>' +
        companies.map(c => `<option value="${c}">${c}</option>`).join('');
}

function filterEmails() {
    const companyFilter = document.getElementById('emailCompanyFilter').value;
    let filtered = [...(crmData.email_conversations || [])];

    if (companyFilter) {
        filtered = filtered.filter(e => e.company === companyFilter);
    }

    filteredData.emails = filtered;
    currentPageNum.emails = 1;
    renderEmails(filtered, 1);
}

function renderEmails(emails, page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageEmails = emails.slice(start, end);

    const container = document.getElementById('emailThreadsList');
    container.innerHTML = pageEmails.length > 0 ? pageEmails.map((e, idx) => {
        const dateRange = e.first_date && e.last_date ? `${e.first_date} to ${e.last_date}` : 'N/A';
        const threadId = `${e.company}_${idx}`;
        return `
        <div class="email-thread" onclick="showEmailThread('${threadId}', ${JSON.stringify(e).replace(/'/g, "&#39;")})">
            <div class="email-thread-header">
                <div class="email-thread-subject">${e.subject || 'No Subject'}</div>
                <div class="email-thread-date">${dateRange}</div>
            </div>
            <div class="email-thread-info">
                <strong>${e.company}</strong> ‚Ä¢ ${e.emails_count || 0} messages ‚Ä¢ Funnel: ${e.funnel || 'Unknown'}
            </div>
        </div>
    `}).join('') : '<div class="empty-state"><h3>No email communications found</h3></div>';

    renderPagination('emails', emails.length, page);
}

// Roles
function initializeRoles() {
    const roles = crmData.companies ? crmData.companies.flatMap(c =>
        (c.roles || []).map(r => ({...r, company: c.company_name}))
    ) : [];
    document.getElementById('rolesCount').textContent = roles.length.toLocaleString();
    filteredData.roles = roles;
    renderRoles(roles, 1);
}

function renderRoles(roles, page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageRoles = roles.slice(start, end);

    const tbody = document.getElementById('rolesTable');
    tbody.innerHTML = pageRoles.length > 0 ? pageRoles.map(r => `
        <tr>
            <td><strong>${r.job_title || r.title || 'N/A'}</strong></td>
            <td>${r.company || 'N/A'}</td>
            <td>${r.posted_date || r.start_date || 'N/A'}</td>
            <td><span class="badge badge-${getStatusColor(r.status)}">${r.status || 'N/A'}</span></td>
            <td>${r.location || 'N/A'}</td>
        </tr>
    `).join('') : '<tr><td colspan="5" class="empty-state">No roles found</td></tr>';

    renderPagination('roles', roles.length, page);
}

// Pagination
function renderPagination(type, totalItems, currentPage) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const container = document.getElementById(`${type}Pagination`);

    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }

    let html = `
        <button onclick="changePage('${type}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‚Üê Previous</button>
        <span class="pagination-info">Page ${currentPage} of ${totalPages} (${totalItems.toLocaleString()} total)</span>
        <button onclick="changePage('${type}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ‚Üí</button>
    `;

    container.innerHTML = html;
}

function changePage(type, page) {
    currentPageNum[type] = page;

    if (type === 'companies') {
        renderCompanies(filteredData.companies, page);
    } else if (type === 'contacts') {
        renderContacts(filteredData.contacts, page);
    } else if (type === 'emails') {
        renderEmails(filteredData.emails, page);
    } else if (type === 'roles') {
        renderRoles(filteredData.roles, page);
    }
}

// Global Search
let searchTimeout;
function performGlobalSearch() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const query = document.getElementById('globalSearch').value.trim().toLowerCase();

        if (query.length < 2) {
            return;
        }

        const results = {
            companies: [],
            contacts: [],
            emails: []
        };

        // Search companies
        (crmData.companies || []).forEach(c => {
            if (c.company_name.toLowerCase().includes(query)) {
                results.companies.push({
                    type: 'Company',
                    title: c.company_name,
                    info: `Status: ${c.status || 'N/A'} ‚Ä¢ Onboarding: ${c.onboarding_date || 'N/A'}`,
                    data: c
                });
            }
        });

        // Search contacts
        (crmData.companies || []).forEach(c => {
            (c.spocs || []).forEach(s => {
                if ((s.name || '').toLowerCase().includes(query) ||
                    (s.email || '').toLowerCase().includes(query)) {
                    results.contacts.push({
                        type: 'Contact',
                        title: s.name || 'N/A',
                        info: `${c.company_name} ‚Ä¢ ${s.email || 'N/A'}`,
                        data: {spoc: s, company: c}
                    });
                }
            });
        });

        // Search emails
        (crmData.email_conversations || []).forEach(e => {
            if ((e.subject || '').toLowerCase().includes(query) ||
                (e.company || '').toLowerCase().includes(query)) {
                results.emails.push({
                    type: 'Email',
                    title: e.subject || 'No Subject',
                    info: `${e.company} ‚Ä¢ ${e.message_count || 0} messages`,
                    data: e
                });
            }
        });

        displaySearchResults(results, query);
    }, 300);
}

function displaySearchResults(results, query) {
    const totalResults = results.companies.length + results.contacts.length + results.emails.length;

    if (totalResults === 0) {
        document.getElementById('searchResultsInfo').textContent = `No results found for "${query}"`;
        document.getElementById('searchResultsContainer').innerHTML = `
            <div class="empty-state">
                <h3>No results found</h3>
                <p>Try searching with different keywords</p>
            </div>
        `;
        showPage('search');
        return;
    }

    document.getElementById('searchResultsInfo').textContent = `Found ${totalResults} results for "${query}"`;

    const allResults = [
        ...results.companies,
        ...results.contacts,
        ...results.emails
    ].slice(0, 50); // Limit to 50 results

    document.getElementById('searchResultsContainer').innerHTML = allResults.map(r => {
        const jsonStr = JSON.stringify(r).replace(/"/g, '&quot;');
        return `
        <div class="search-result-item" onclick='handleSearchResultClick(${jsonStr})'>
            <div>
                <span class="search-result-type">${r.type}</span>
                <span class="search-result-title">${r.title}</span>
            </div>
            <div class="search-result-info">${r.info}</div>
        </div>
    `}).join('');

    showPage('search');
}

function handleSearchResultClick(result) {
    if (result.type === 'Company') {
        showCompanyDetail(result.data.company_name);
    } else if (result.type === 'Email') {
        showEmailThread(result.data.thread_id);
    } else if (result.type === 'Contact') {
        showCompanyDetail(result.data.company.company_name);
    }
}

// Company Detail Modal
function showCompanyDetail(companyName) {
    const company = (crmData.companies || []).find(c => c.company_name === companyName);
    if (!company) return;

    currentCompanyData = company;
    document.getElementById('modalCompanyName').textContent = company.company_name;

    // Switch to overview tab
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector('.tab-btn').classList.add('active');
    document.getElementById('overviewTab').classList.add('active');

    // Overview
    const companyEmailCount = (crmData.email_conversations || []).filter(e => e.company === companyName).length;
    document.getElementById('companyOverview').innerHTML = `
        <div class="info-item">
            <label>Client ID</label>
            <value>${company.client_id || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Status</label>
            <value><span class="badge badge-${getStatusColor(company.status)}">${company.status || 'N/A'}</span></value>
        </div>
        <div class="info-item">
            <label>Funnel Stage</label>
            <value><span class="badge badge-${getStatusColor(company.funnel_stage)}">${company.funnel_stage || 'Unknown'}</span></value>
        </div>
        <div class="info-item">
            <label>First Engagement</label>
            <value>${company.first_engagement || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Last Engagement</label>
            <value>${company.last_engagement || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Industry</label>
            <value>${company.industry || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Company Size</label>
            <value>${company.company_size || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Revenue</label>
            <value>${company.revenue || 'N/A'}</value>
        </div>
        <div class="info-item">
            <label>Total Roles</label>
            <value>${company.roles_count || 0}</value>
        </div>
        <div class="info-item">
            <label>Total SPOCs</label>
            <value>${company.spocs_count || 0}</value>
        </div>
        <div class="info-item">
            <label>Email Conversations</label>
            <value>${companyEmailCount}</value>
        </div>
        <div class="info-item">
            <label>Days Since Last Contact</label>
            <value>${company.days_since_last_contact || 'N/A'}</value>
        </div>
    `;

    // Roles
    const roles = company.roles || [];
    document.getElementById('companyRoles').innerHTML = roles.length > 0 ? `
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Role Title</th>
                    <th>Posted Date</th>
                    <th>Updated Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${roles.map(r => `
                    <tr>
                        <td><strong>${r.job_title || r.title || 'N/A'}</strong></td>
                        <td>${r.posted_date || r.start_date || 'N/A'}</td>
                        <td>${r.updated_date || 'N/A'}</td>
                        <td><span class="badge badge-${getStatusColor(r.status)}">${r.status || 'N/A'}</span></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    ` : '<div class="empty-state"><h3>No roles found</h3></div>';

    // SPOCs
    const spocs = company.spocs || [];
    document.getElementById('companySPOCs').innerHTML = spocs.length > 0 ? `
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Position</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                ${spocs.map(s => `
                    <tr>
                        <td><strong>${s.name || 'N/A'}</strong></td>
                        <td>${s.position || 'N/A'}</td>
                        <td>${s.email || 'N/A'}</td>
                        <td>${s.phone || 'N/A'}</td>
                        <td><span class="badge badge-${getStatusColor(s.status)}">${s.status || 'N/A'}</span></td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    ` : '<div class="empty-state"><h3>No SPOCs found</h3></div>';

    // Emails
    const companyEmails = (crmData.email_conversations || []).filter(e => e.company === companyName);
    document.getElementById('companyEmails').innerHTML = companyEmails.length > 0 ?
        companyEmails.map((e, idx) => {
            const dateRange = e.first_date && e.last_date ? `${e.first_date} to ${e.last_date}` : 'N/A';
            const threadId = `${e.company}_${idx}`;
            return `
            <div class="email-thread" onclick="event.stopPropagation(); showEmailThread('${threadId}', ${JSON.stringify(e).replace(/'/g, "&#39;")})">
                <div class="email-thread-header">
                    <div class="email-thread-subject">${e.subject || 'No Subject'}</div>
                    <div class="email-thread-date">${dateRange}</div>
                </div>
                <div class="email-thread-info">
                    ${e.emails_count || 0} messages ‚Ä¢ Funnel: ${e.funnel || 'Unknown'}
                </div>
            </div>
        `}).join('') : '<div class="empty-state"><h3>No email communications found</h3></div>';

    document.getElementById('companyModal').classList.add('active');
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    event.target.classList.add('active');
    document.getElementById(`${tabName}Tab`).classList.add('active');
}

function closeModal() {
    document.getElementById('companyModal').classList.remove('active');
}

// Email Thread Modal
function showEmailThread(threadId, emailData) {
    const conversation = emailData;

    document.getElementById('modalThreadSubject').textContent = conversation.subject || 'No Subject';

    const dateRange = conversation.first_date && conversation.last_date ?
        `${conversation.first_date} to ${conversation.last_date}` : 'N/A';

    document.getElementById('emailThreadContent').innerHTML = `
        <div class="info-grid">
            <div class="info-item">
                <label>Company</label>
                <value>${conversation.company}</value>
            </div>
            <div class="info-item">
                <label>Date Range</label>
                <value>${dateRange}</value>
            </div>
            <div class="info-item">
                <label>Email Count</label>
                <value>${conversation.emails_count || 0}</value>
            </div>
            <div class="info-item">
                <label>Funnel Stage</label>
                <value><span class="badge badge-${getStatusColor(conversation.funnel)}">${conversation.funnel || 'Unknown'}</span></value>
            </div>
            <div class="info-item">
                <label>First Email</label>
                <value>${conversation.first_date || 'N/A'}</value>
            </div>
            <div class="info-item">
                <label>Last Email</label>
                <value>${conversation.last_date || 'N/A'}</value>
            </div>
            <div class="info-item">
                <label>Days Since Last</label>
                <value>${conversation.days_ago || 'N/A'} days</value>
            </div>
        </div>
        <div style="margin-top: 20px;">
            <p style="color: #7f8c8d; font-size: 14px;">üìß This conversation contains ${conversation.emails_count || 0} emails between ${conversation.first_date || 'N/A'} and ${conversation.last_date || 'N/A'}.</p>
        </div>
    `;

    document.getElementById('emailThreadModal').classList.add('active');
}

function closeEmailModal() {
    document.getElementById('emailThreadModal').classList.remove('active');
}

// Utilities
function getStatusColor(status) {
    const statusMap = {
        'Active': 'green',
        'Verified': 'blue',
        'Inactive': 'gray',
        'Pending': 'yellow',
        'Closed': 'red'
    };
    return statusMap[status] || 'gray';
}

// Close modals on background click
document.getElementById('companyModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
});

document.getElementById('emailThreadModal').addEventListener('click', function(e) {
    if (e.target === this) closeEmailModal();
});
</script>

</body>
</html>
